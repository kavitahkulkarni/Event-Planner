"use strict";function writeNewEvent(e,t,n,a,s,r,i,l,o,d,u,m,c){var v={uid:e,author:t,authorPic:n,eventName:a,eventType:s,eventHost:r,eventStartDate:i,eventStartTime:l,eventEndDate:o,eventEndTime:d,eventLocation:u,eventGuests:m,eventMessage:c,starCount:0},p=firebase.database().ref().child("events").push().key,g={};return g["/events/"+p]=v,g["/user-events/"+e+"/"+p]=v,firebase.database().ref().update(g)}function toggleStar(e,t){e.transaction(function(e){return e&&(e.stars&&e.stars[t]?(e.starCount--,e.stars[t]=null):(e.starCount++,e.stars||(e.stars={}),e.stars[t]=!0)),e})}function createEventElement(e,t,n,a,s,r,i,l,o,d,u,m,c,v){var p=firebase.auth().currentUser.uid,g='<div class="event mdl-cell mdl-cell--12-col mdl-cell--6-col-tablet mdl-cell--4-col-desktop mdl-grid mdl-grid--no-spacing"><div class="mdl-card mdl-shadow--2dp"><div class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white"><h4 class="mdl-card__title-text"></h4></div><div class="header"><div><div class="avatar"></div><div class="username mdl-color-text--black"></div></div></div><span class="star"><div class="not-starred material-icons">star_border</div><div class="starred material-icons">star</div><div class="star-count">0</div></span><div class="display eventType"></div><div class="display eventHost"></div><div class="display eventStartDateTime"></div><div class="display eventEndDateTime"></div><div class="display eventLocation"></div><div class="display eventGuests"></div><div class="display message"></div><div class="comments-container"></div><form class="add-comment" action="#"><div class="mdl-textfield mdl-js-textfield"><input class="mdl-textfield__input new-comment" type="text"><label class="mdl-textfield__label">Comment...</label></div></form></div></div>',f=document.createElement("div");f.innerHTML=g;var h=f.firstChild;componentHandler&&componentHandler.upgradeElements(h.getElementsByClassName("mdl-textfield")[0]);var y=h.getElementsByClassName("add-comment")[0],E=h.getElementsByClassName("new-comment")[0],w=h.getElementsByClassName("starred")[0],B=h.getElementsByClassName("not-starred")[0];h.getElementsByClassName("mdl-card__title-text")[0].innerText=t,h.getElementsByClassName("username")[0].innerText=m||"Anonymous",h.getElementsByClassName("eventType")[0].innerText="Event Type: "+n,h.getElementsByClassName("eventHost")[0].innerText="Event Host: "+a,h.getElementsByClassName("eventStartDateTime")[0].innerText="Start Date: "+s+" Time: "+r,h.getElementsByClassName("eventEndDateTime")[0].innerText="End Date: "+i+" Time: "+l,h.getElementsByClassName("eventLocation")[0].innerText="Location: "+o,h.getElementsByClassName("eventGuests")[0].innerText="Guests: "+d,h.getElementsByClassName("message")[0].innerText="Message from organizer: "+u,h.getElementsByClassName("avatar")[0].style.backgroundImage='url("'+(v||"./images/silhouette.jpg")+'")';var b=firebase.database().ref("event-comments/"+e);b.on("child_added",function(e){addCommentElement(h,e.key,e.val().text,e.val().author)}),b.on("child_changed",function(e){setCommentValues(h,e.key,e.val().text,e.val().author)}),b.on("child_removed",function(e){deleteComment(h,e.key)});var I=firebase.database().ref("events/"+e+"/starCount");I.on("value",function(e){updateStarCount(h,e.val())});var C=firebase.database().ref("events/"+e+"/stars/"+p);C.on("value",function(e){updateStarredByCurrentUser(h,e.val())}),listeningFirebaseRefs.push(b),listeningFirebaseRefs.push(I),listeningFirebaseRefs.push(C),y.onsubmit=function(t){t.preventDefault();var n=firebase.auth().currentUser.uid;return firebase.database().ref("/users/"+n).once("value").then(function(t){var n=t.val().email;createNewComment(e,n,p,E.value),E.value="",E.parentElement.MaterialTextfield.boundUpdateClassesHandler()})};var S=function(){var t=firebase.database().ref("/events/"+e),n=firebase.database().ref("/user-events/"+c+"/"+e);toggleStar(t,p),toggleStar(n,p)};return B.onclick=S,w.onclick=S,h}function createNewComment(e,t,n,a){firebase.database().ref("event-comments/"+e).push({text:a,author:t,uid:n})}function updateStarredByCurrentUser(e,t){t?(e.getElementsByClassName("starred")[0].style.display="inline-block",e.getElementsByClassName("not-starred")[0].style.display="none"):(e.getElementsByClassName("starred")[0].style.display="none",e.getElementsByClassName("not-starred")[0].style.display="inline-block")}function updateStarCount(e,t){e.getElementsByClassName("star-count")[0].innerText=t}function addCommentElement(e,t,n,a){var s=document.createElement("div");s.classList.add("comment-"+t),s.innerHTML='<span class="username"></span><span class="comment"></span>',s.getElementsByClassName("comment")[0].innerText=n,s.getElementsByClassName("username")[0].innerText=a||"Anonymous";var r=e.getElementsByClassName("comments-container")[0];r.appendChild(s)}function setCommentValues(e,t,n,a){var s=e.getElementsByClassName("comment-"+t)[0];s.getElementsByClassName("comment")[0].innerText=n,s.getElementsByClassName("fp-username")[0].innerText=a}function deleteComment(e,t){var n=e.getElementsByClassName("comment-"+t)[0];n.parentElement.removeChild(n)}function startDatabaseQueries(){var e=firebase.auth().currentUser.uid,t=firebase.database().ref("user-events/"+e).orderByChild("starCount"),n=firebase.database().ref("events").limitToLast(100),a=firebase.database().ref("user-events/"+e),s=function(e,t){e.on("child_added",function(e){var n=e.val().author||"Anonymous",a=t.getElementsByClassName("events-container")[0];a.insertBefore(createEventElement(e.key,e.val().eventName,e.val().eventType,e.val().eventHost,e.val().eventStartDate,e.val().eventStartTime,e.val().eventEndDate,e.val().eventEndTime,e.val().eventLocation,e.val().eventGuests,e.val().eventMessage,n,e.val().uid,e.val().authorPic),a.firstChild)})};s(t,topUserEventsSection),s(n,recentEventsSection),s(a,userEventsSection),listeningFirebaseRefs.push(t),listeningFirebaseRefs.push(n),listeningFirebaseRefs.push(a)}function writeUserData(e,t,n,a){firebase.database().ref("users/"+e).set({username:t,email:n,profile_picture:a})}function cleanupUi(){topUserEventsSection.getElementsByClassName("events-container")[0].innerHTML="",recentEventsSection.getElementsByClassName("events-container")[0].innerHTML="",userEventsSection.getElementsByClassName("events-container")[0].innerHTML="",listeningFirebaseRefs.forEach(function(e){e.off()}),listeningFirebaseRefs=[]}function onAuthStateChanged(e){cleanupUi(),e?(splashPage.style.display="none",writeUserData(e.uid,e.displayName,e.email,e.photoURL),startDatabaseQueries()):splashPage.style.display=""}function newEventForCurrentUser(e,t,n,a,s,r,i,l,o,d){var u=firebase.auth().currentUser.uid;return firebase.database().ref("/users/"+u).once("value").then(function(u){var m=u.val().email;return writeNewEvent(firebase.auth().currentUser.uid,m,firebase.auth().currentUser.photoURL,e,t,n,a,s,r,i,l,o,d)})}function showSection(e,t){recentEventsSection.style.display="none",userEventsSection.style.display="none",topUserEventsSection.style.display="none",addEvent.style.display="none",recentMenuButton.classList.remove("is-active"),myEventsMenuButton.classList.remove("is-active"),myTopEventsMenuButton.classList.remove("is-active"),e&&(e.style.display="block"),t&&t.classList.add("is-active")}function initAutocomplete(){autocomplete=new google.maps.places.Autocomplete(document.getElementById("new-event-location"),{types:["geocode"]})}function geolocate(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var t={lat:e.coords.latitude,lng:e.coords.longitude},n=new google.maps.Circle({center:t,radius:e.coords.accuracy});autocomplete.setBounds(n.getBounds())})}var eventForm=document.getElementById("event-form"),welcomeForm=document.getElementById("welcome-form"),signupForm=document.getElementById("signup-form"),eventFormStep1=document.getElementById("step1"),eventFormStep2=document.getElementById("step2"),eventFormStep3=document.getElementById("step3"),eventFormStep4=document.getElementById("step4"),eventNameInput=document.getElementById("new-event-name"),eventTypeInput=document.getElementById("new-event-type"),eventHostInput=document.getElementById("new-event-host"),eventStartDateInput=document.getElementById("new-event-start-date"),eventStartTimeInput=document.getElementById("new-event-start-time"),eventEndDateInput=document.getElementById("new-event-end-date"),eventEndTimeInput=document.getElementById("new-event-end-time"),eventLocationInput=document.getElementById("new-event-location"),eventGuestsInput=document.getElementById("new-event-guests"),eventMessageInput=document.getElementById("new-event-message"),newUserName=document.getElementById("new-user-name"),newUserEmail=document.getElementById("new-user-email"),confirmNewUserEmail=document.getElementById("confirm-new-user-email"),newUserPassword=document.getElementById("new-user-password"),signUpButton=document.getElementById("sign-up-button"),emailInput=document.getElementById("email"),passwordInput=document.getElementById("password"),signInButton=document.getElementById("sign-in-button"),signOutButton=document.getElementById("sign-out-button"),passwordResetButton=document.getElementById("password-reset-button"),splashPage=document.getElementById("page-splash"),addEvent=document.getElementById("add-event"),addButton=document.getElementById("add"),recentEventsSection=document.getElementById("recent-events-list"),userEventsSection=document.getElementById("user-events-list"),topUserEventsSection=document.getElementById("top-user-events-list"),recentMenuButton=document.getElementById("menu-recent"),myEventsMenuButton=document.getElementById("menu-my-events"),myTopEventsMenuButton=document.getElementById("menu-my-top-events"),listeningFirebaseRefs=[];window.addEventListener("load",function(){welcomeForm.onsubmit=function(e){e.preventDefault();var t=emailInput.value,n=passwordInput.value;$("#welcome-form").valid()&&firebase.auth().signInWithEmailAndPassword(t,n).catch(function(e){var t=e.code;e.message;"auth/wrong-password"===t?alert("Invalid password."):"auth/user-not-found"===t&&alert("You seem to be a new user, please signup first"),console.log(e)})},signupForm.onsubmit=function(e){e.preventDefault();var t=newUserEmail.value,n=newUserPassword.value;newUserName.value,confirmNewUserEmail.value;$("#signup-form").valid()&&firebase.auth().createUserWithEmailAndPassword(t,n).catch(function(e){var t=e.code;e.message;"auth/invalid-email"===t?alert("Enter valid email"):(alert(e.message),console.log(e))})},passwordResetButton.addEventListener("click",function(){var e=emailInput.value,t=e.indexOf("@"),n=e.lastIndexOf(".");t<1||n<t+2||n+2>=e.length?alert("Enter a valid e-mail"):alert("SEND PASSWORD RESET button is pressed to send password reset link to e-mail: "+e+"!\n(It doesn't send the actual email :))")}),signOutButton.addEventListener("click",function(){firebase.auth().signOut()}),firebase.auth().onAuthStateChanged(onAuthStateChanged),eventForm.onsubmit=function(e){e.preventDefault();var t=eventNameInput.value,n=eventTypeInput.value,a=eventHostInput.value,s=eventStartDateInput.value,r=eventStartTimeInput.value,i=eventEndDateInput.value,l=eventEndTimeInput.value,o=eventLocationInput.value,d=eventGuestsInput.value,u=eventMessageInput.value;eventFormStep4.style.display="none",eventFormStep1.style.display="block",t&&n&&(newEventForCurrentUser(t,n,a,s,r,i,l,o,d,u).then(function(){myEventsMenuButton.click()}),eventNameInput.value="",eventTypeInput.value="",eventHostInput.value="",eventStartDateInput.value="",eventStartTimeInput.value="",eventEndDateInput.value="",eventEndTimeInput.value="",eventLocationInput.value="",eventGuestsInput.value="",eventMessageInput.value="")},recentMenuButton.onclick=function(){showSection(recentEventsSection,recentMenuButton)},myEventsMenuButton.onclick=function(){showSection(userEventsSection,myEventsMenuButton)},myTopEventsMenuButton.onclick=function(){showSection(topUserEventsSection,myTopEventsMenuButton)},addButton.onclick=function(){showSection(addEvent),eventMessageInput.value="",eventNameInput.value=""},recentMenuButton.onclick()},!1),$(document).ready(function(){function e(){var e=$("#new-user-password").val();$("#new-event-end-date").val();return!(!e.match(/\d/g)||!e.match(/[A-Z]/g))}function t(){var e=$("#new-event-start-date").val(),t=$("#new-event-end-date").val();if(!e||!t)return!1;if(t>e)return!0;if(t==e){var n=$("#new-event-end-time").parseValToNumber(),a=$("#new-event-start-time").parseValToNumber();return n>a}return!1}function n(e){var t=e.split(/\D/);return new Date(t[0],(--t[1]),t[2])}function a(){var e=$("#new-event-start-date").val(),t=$("#new-event-start-time").val(),a=new Date,s=new Date;if(s.setHours(0,0,0,0),n(e)<s)return!1;if(n(e)>s)return!0;var r=parseInt(t.substr(0,2)),i=parseInt(t.substr(3,2)),l=a.getHours(),o=a.getMinutes();return!(60*r+i<60*l+o)}$("#welcome-form").validate({ignore:":not(:visible)",rules:{email:{required:!0,email:!0},password:{required:!0}},messages:{email:{required:"Enter email",email:"Enter valid email"},password:{required:"Enter password"}}}),$("#signup-form").validate({ignore:":not(:visible)",rules:{name:{required:!0,minlength:4},email:{required:!0,email:!0,emailCheck:!0},email:{required:!0,equalTo:"#new-user-email",email:!0,emailCheck:!0},"new-user-password":{required:!0,minlength:6,checkStrength:!0}},messages:{name:{required:"Please enter the User Name",minlength:"User Name should be at least 4 characters"},email:{required:"Please enter an email",email:"Please enter valid email"},emailC:{required:"Please enter the email again",equalTo:"Should be same as the email above",email:"Please enter valid email"},"new-user-password":{required:"Please enter a password",minlength:"Password should be minimum 6 characters"}}}),jQuery.validator.addMethod("checkStrength",function(t,n){return e()},"Password should contain at least one uppercase character and one number"),jQuery.validator.addMethod("emailCheck",function(e,t){var n=e.indexOf("@"),a=e.lastIndexOf(".");return n>=1&&a>=n+2&&a+2<e.length},"Please enter valid email");var s=1,r=$(".step"),i=$(".next"),l=$(".back"),o=$(".create"),d=function(e){var t,n=parseFloat(100/r.length)*(e-1);t=0==n?5:n,n=n.toFixed(),$(".progress-bar").css("width",t+"%").html(n+"%")},u=function(e){var t=parseInt(r.length);$(".action").hide(),e<t&&i.show(),e>1&&l.show(),e==t&&($(".display label.lbl").each(function(){$(this).html($("#"+$(this).data("id")).val())}),i.hide(),o.show())};r.not(":eq(0)").hide(),u(s),d(s),i.click(function(){s<r.length&&$("#event-form").valid()&&(r.show(),0==s?document.getElementById("new-event-name").focus():1==s?document.getElementById("new-event-start-date").focus():2==s&&document.getElementById("new-event-location").focus(),r.not(":eq("+s++ +")").hide(),d(s)),u(s)}),l.click(function(){s>1&&(s-=2,s<r.length&&(r.show(),0==s?document.getElementById("new-event-name").focus():1==s?document.getElementById("new-event-start-date").focus():2==s&&document.getElementById("new-event-location").focus(),r.not(":eq("+s++ +")").hide(),d(s))),u(s)}),o.click(function(){s=1,u(s),d(s)}),$("#event-form").validate({ignore:":not(:visible)",rules:{"new-event-name":{required:!0,minlength:4},"new-event-type":{required:!0,minlength:4},"new-event-host":{required:!0,minlength:2},"new-event-start-date":{required:!0,date:!0,checkStartDate:!0},"new-event-start-time":{required:!0,timeCheck:!0,checkStartDateTime:!0},"new-event-end-date":{required:!0,date:!0,checkDates:!0},"new-event-end-time":{required:!0,timeCheck:!0,checkTimes:!0},"new-event-location":"required","new-event-guests":"required"},messages:{"new-event-name":{required:"Please enter an Event Name",minlength:"Event Name should be at least 4 characters"},"new-event-type":{required:"Please enter an Event Type",minlength:"Event Type should be at least 4 characters"},"new-event-host":{required:"Please enter the name of the host",minlength:"Event Type should be at least 2 characters"},"new-event-start-date":{required:"Please enter the date of an event",date:"Please enter a valid date"},"new-event-start-time":{required:"Please enter the start time of an event",time:"Please enter a valid time"},"new-event-end-date":{required:"Please enter the end date of an event",date:"Please enter a valid end date"},"new-event-end-time":{required:"Please enter the end time of an event",time:"Please enter a valid end time"},"new-event-location":"Please enter the location of the event","new-event-guests":"Please enter the list of guests"}}),$.validator.addMethod("timeCheck",function(e,t){return this.optional(t)||/^(([0-1]?[0-9])|([2][0-3])):([0-5]?[0-9])(:([0-5]?[0-9]))?$/i.test(e)},"Please enter a valid time."),$.fn.parseValToNumber=function(){return parseInt($(this).val().replace(":",""),10)||0},jQuery.validator.addMethod("checkTimes",function(e,n){return t()},"End time must be after start time"),jQuery.validator.addMethod("checkDates",function(e,t){var n=$("#new-event-start-date").val();return Date.parse(n)<=Date.parse(e)},"End date cannot be before start date"),jQuery.validator.addMethod("checkStartDate",function(e,t){var a=$("#new-event-start-date").val(),s=new Date;return s.setHours(0,0,0,0),n(a)>=s},"Start date should be current/future"),jQuery.validator.addMethod("checkStartDateTime",function(e,t){return a()},"Start time should be in future")});var placeSearch,autocomplete,componentForm={street_number:"short_name",route:"long_name",locality:"long_name",administrative_area_level_1:"short_name",country:"long_name",postal_code:"short_name"};