"use strict";function writeNewEvent(e,t,n,s,a,l,i,r,o,u,m,d,v){var c={uid:e,author:t,authorPic:n,eventName:s,eventType:a,eventHost:l,eventStartDate:i,eventStartTime:r,eventEndDate:o,eventEndTime:u,eventLocation:m,eventGuests:d,eventMessage:v,starCount:0},p=firebase.database().ref().child("events").push().key,E={};return E["/events/"+p]=c,E["/user-events/"+e+"/"+p]=c,firebase.database().ref().update(E)}function toggleStar(e,t){e.transaction(function(e){return e&&(e.stars&&e.stars[t]?(e.starCount--,e.stars[t]=null):(e.starCount++,e.stars||(e.stars={}),e.stars[t]=!0)),e})}function createEventElement(e,t,n,s,a,l,i,r,o,u,m,d,v,c){var p=firebase.auth().currentUser.uid,E='<div class="event mdl-cell mdl-cell--12-col mdl-cell--6-col-tablet mdl-cell--4-col-desktop mdl-grid mdl-grid--no-spacing"><div class="mdl-card mdl-shadow--2dp"><div class="mdl-card__title mdl-color--light-blue-600 mdl-color-text--white"><h4 class="mdl-card__title-text"></h4></div><div class="header"><div><div class="avatar"></div><div class="username mdl-color-text--black"></div></div></div><span class="star"><div class="not-starred material-icons">star_border</div><div class="starred material-icons">star</div><div class="star-count">0</div></span><div class="display eventType"></div><div class="display eventHost"></div><div class="display eventStartDateTime"></div><div class="display eventEndDateTime"></div><div class="display eventLocation"></div><div class="display eventGuests"></div><div class="display message"></div><div class="comments-container"></div><form class="add-comment" action="#"><div class="mdl-textfield mdl-js-textfield"><input class="mdl-textfield__input new-comment" type="text"><label class="mdl-textfield__label">Comment...</label></div></form></div></div>',y=document.createElement("div");y.innerHTML=E;var g=y.firstChild;componentHandler&&componentHandler.upgradeElements(g.getElementsByClassName("mdl-textfield")[0]);var f=g.getElementsByClassName("add-comment")[0],B=g.getElementsByClassName("new-comment")[0],I=g.getElementsByClassName("starred")[0],h=g.getElementsByClassName("not-starred")[0];g.getElementsByClassName("mdl-card__title-text")[0].innerText=t,g.getElementsByClassName("username")[0].innerText=d||"Anonymous",g.getElementsByClassName("eventType")[0].innerText="Event Type: "+n,g.getElementsByClassName("eventHost")[0].innerText="Event Host: "+s,g.getElementsByClassName("eventStartDateTime")[0].innerText="Start Date: "+a+" Time: "+l,g.getElementsByClassName("eventEndDateTime")[0].innerText="End Date: "+i+" Time: "+r,g.getElementsByClassName("eventLocation")[0].innerText="Location: "+o,g.getElementsByClassName("eventGuests")[0].innerText="Guests: "+u,g.getElementsByClassName("message")[0].innerText="Message from organizer: "+m,g.getElementsByClassName("avatar")[0].style.backgroundImage='url("'+(c||"./images/silhouette.jpg")+'")';var b=firebase.database().ref("event-comments/"+e);b.on("child_added",function(e){addCommentElement(g,e.key,e.val().text,e.val().author)}),b.on("child_changed",function(e){setCommentValues(g,e.key,e.val().text,e.val().author)}),b.on("child_removed",function(e){deleteComment(g,e.key)});var w=firebase.database().ref("events/"+e+"/starCount");w.on("value",function(e){updateStarCount(g,e.val())});var C=firebase.database().ref("events/"+e+"/stars/"+p);C.on("value",function(e){updateStarredByCurrentUser(g,e.val())}),listeningFirebaseRefs.push(b),listeningFirebaseRefs.push(w),listeningFirebaseRefs.push(C),f.onsubmit=function(t){t.preventDefault();var n=firebase.auth().currentUser.uid;return firebase.database().ref("/users/"+n).once("value").then(function(t){var n=t.val().email;createNewComment(e,n,p,B.value),B.value="",B.parentElement.MaterialTextfield.boundUpdateClassesHandler()})};var S=function(){var t=firebase.database().ref("/events/"+e),n=firebase.database().ref("/user-events/"+v+"/"+e);toggleStar(t,p),toggleStar(n,p)};return h.onclick=S,I.onclick=S,g}function createNewComment(e,t,n,s){firebase.database().ref("event-comments/"+e).push({text:s,author:t,uid:n})}function updateStarredByCurrentUser(e,t){t?(e.getElementsByClassName("starred")[0].style.display="inline-block",e.getElementsByClassName("not-starred")[0].style.display="none"):(e.getElementsByClassName("starred")[0].style.display="none",e.getElementsByClassName("not-starred")[0].style.display="inline-block")}function updateStarCount(e,t){e.getElementsByClassName("star-count")[0].innerText=t}function addCommentElement(e,t,n,s){var a=document.createElement("div");a.classList.add("comment-"+t),a.innerHTML='<span class="username"></span><span class="comment"></span>',a.getElementsByClassName("comment")[0].innerText=n,a.getElementsByClassName("username")[0].innerText=s||"Anonymous";var l=e.getElementsByClassName("comments-container")[0];l.appendChild(a)}function setCommentValues(e,t,n,s){var a=e.getElementsByClassName("comment-"+t)[0];a.getElementsByClassName("comment")[0].innerText=n,a.getElementsByClassName("fp-username")[0].innerText=s}function deleteComment(e,t){var n=e.getElementsByClassName("comment-"+t)[0];n.parentElement.removeChild(n)}function startDatabaseQueries(){var e=firebase.auth().currentUser.uid,t=firebase.database().ref("user-events/"+e).orderByChild("starCount"),n=firebase.database().ref("events").limitToLast(100),s=firebase.database().ref("user-events/"+e),a=function(e,t){e.on("child_added",function(e){var n=e.val().author||"Anonymous",s=t.getElementsByClassName("events-container")[0];s.insertBefore(createEventElement(e.key,e.val().eventName,e.val().eventType,e.val().eventHost,e.val().eventStartDate,e.val().eventStartTime,e.val().eventEndDate,e.val().eventEndTime,e.val().eventLocation,e.val().eventGuests,e.val().eventMessage,n,e.val().uid,e.val().authorPic),s.firstChild)})};a(t,topUserEventsSection),a(n,recentEventsSection),a(s,userEventsSection),listeningFirebaseRefs.push(t),listeningFirebaseRefs.push(n),listeningFirebaseRefs.push(s)}function writeUserData(e,t,n,s){firebase.database().ref("users/"+e).set({username:t,email:n,profile_picture:s})}function cleanupUi(){topUserEventsSection.getElementsByClassName("events-container")[0].innerHTML="",recentEventsSection.getElementsByClassName("events-container")[0].innerHTML="",userEventsSection.getElementsByClassName("events-container")[0].innerHTML="",listeningFirebaseRefs.forEach(function(e){e.off()}),listeningFirebaseRefs=[]}function onAuthStateChanged(e){cleanupUi(),e?(splashPage.style.display="none",writeUserData(e.uid,e.displayName,e.email,e.photoURL),startDatabaseQueries()):splashPage.style.display=""}function newEventForCurrentUser(e,t,n,s,a,l,i,r,o,u){var m=firebase.auth().currentUser.uid;return firebase.database().ref("/users/"+m).once("value").then(function(m){var d=m.val().email;return writeNewEvent(firebase.auth().currentUser.uid,d,firebase.auth().currentUser.photoURL,e,t,n,s,a,l,i,r,o,u)})}function showSection(e,t){recentEventsSection.style.display="none",userEventsSection.style.display="none",topUserEventsSection.style.display="none",addEvent.style.display="none",recentMenuButton.classList.remove("is-active"),myEventsMenuButton.classList.remove("is-active"),myTopEventsMenuButton.classList.remove("is-active"),e&&(e.style.display="block"),t&&t.classList.add("is-active")}var eventForm=document.getElementById("event-form"),welcomeForm=document.getElementById("welcome-form"),signupForm=document.getElementById("signup-form"),eventFormStep1=document.getElementById("step1"),eventFormStep2=document.getElementById("step2"),eventFormStep3=document.getElementById("step3"),eventFormStep4=document.getElementById("step4"),eventNameInput=document.getElementById("new-event-name"),eventTypeInput=document.getElementById("new-event-type"),eventHostInput=document.getElementById("new-event-host"),eventStartDateInput=document.getElementById("new-event-start-date"),eventStartTimeInput=document.getElementById("new-event-start-time"),eventEndDateInput=document.getElementById("new-event-end-date"),eventEndTimeInput=document.getElementById("new-event-end-time"),eventLocationInput=document.getElementById("new-event-location"),eventGuestsInput=document.getElementById("new-event-guests"),eventMessageInput=document.getElementById("new-event-message"),newUserName=document.getElementById("new-user-name"),newUserEmail=document.getElementById("new-user-email"),confirmNewUserEmail=document.getElementById("confirm-new-user-email"),newUserPassword=document.getElementById("new-user-password"),signUpButton=document.getElementById("sign-up-button"),emailInput=document.getElementById("email"),passwordInput=document.getElementById("password"),signInButton=document.getElementById("sign-in-button"),signOutButton=document.getElementById("sign-out-button"),passwordResetButton=document.getElementById("password-reset-button"),splashPage=document.getElementById("page-splash"),addEvent=document.getElementById("add-event"),addButton=document.getElementById("add"),recentEventsSection=document.getElementById("recent-events-list"),userEventsSection=document.getElementById("user-events-list"),topUserEventsSection=document.getElementById("top-user-events-list"),recentMenuButton=document.getElementById("menu-recent"),myEventsMenuButton=document.getElementById("menu-my-events"),myTopEventsMenuButton=document.getElementById("menu-my-top-events"),listeningFirebaseRefs=[];window.addEventListener("load",function(){welcomeForm.onsubmit=function(e){e.preventDefault();var t=emailInput.value,n=passwordInput.value;$("#welcome-form").valid()&&firebase.auth().signInWithEmailAndPassword(t,n).catch(function(e){var t=e.code;e.message;"auth/wrong-password"===t?alert("Invalid password."):"auth/user-not-found"===t&&alert("You seem to be a new user, please signup first"),console.log(e)})},signupForm.onsubmit=function(e){e.preventDefault();var t=newUserEmail.value,n=newUserPassword.value;newUserName.value,confirmNewUserEmail.value;$("#signup-form").valid()&&firebase.auth().createUserWithEmailAndPassword(t,n).catch(function(e){var t=e.code;e.message;"auth/invalid-email"===t?alert("Enter valid email"):(alert(e.message),console.log(e))})},passwordResetButton.addEventListener("click",function(){var e=emailInput.value,t=e.indexOf("@"),n=e.lastIndexOf(".");t<1||n<t+2||n+2>=e.length?alert("Enter a valid e-mail"):alert("SEND PASSWORD RESET button is pressed to send password reset link to e-mail: "+e+"!\n(It doesn't send the actual email :))")}),signOutButton.addEventListener("click",function(){firebase.auth().signOut()}),firebase.auth().onAuthStateChanged(onAuthStateChanged),eventForm.onsubmit=function(e){e.preventDefault();var t=eventNameInput.value,n=eventTypeInput.value,s=eventHostInput.value,a=eventStartDateInput.value,l=eventStartTimeInput.value,i=eventEndDateInput.value,r=eventEndTimeInput.value,o=eventLocationInput.value,u=eventGuestsInput.value,m=eventMessageInput.value;eventFormStep4.style.display="none",eventFormStep1.style.display="block",t&&n&&(newEventForCurrentUser(t,n,s,a,l,i,r,o,u,m).then(function(){myEventsMenuButton.click()}),eventNameInput.value="",eventTypeInput.value="",eventHostInput.value="",eventStartDateInput.value="",eventStartTimeInput.value="",eventEndDateInput.value="",eventEndTimeInput.value="",eventLocationInput.value="",eventGuestsInput.value="",eventMessageInput.value="")},recentMenuButton.onclick=function(){showSection(recentEventsSection,recentMenuButton)},myEventsMenuButton.onclick=function(){showSection(userEventsSection,myEventsMenuButton)},myTopEventsMenuButton.onclick=function(){showSection(topUserEventsSection,myTopEventsMenuButton)},addButton.onclick=function(){showSection(addEvent),eventMessageInput.value="",eventNameInput.value=""},recentMenuButton.onclick()},!1);